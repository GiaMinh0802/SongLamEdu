
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Qu·∫£n l√Ω l·ªõp h·ªçc - Song L√¢m Edu</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/classes.css}">
</head>
<body>
<div th:replace="~{fragments/header}"></div>
<div class="app-shell">
    <div th:replace="~{fragments/sidebar}"></div>
    <main class="app-content">
        <h1 class="page-title-box">üìö Qu·∫£n l√Ω l·ªõp h·ªçc</h1>

        <div id="info-container" class="info-wrap editing">

            <!-- B·ªô l·ªçc -->
            <div class="info-section">
                <h2 class="info-section-title">B·ªô l·ªçc t√¨m ki·∫øm</h2>
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="academicYearSelect">NƒÉm h·ªçc</label>
                        <select id="academicYearSelect" class="info-value" onchange="loadClasses()">
                            <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                            <option th:each="year : ${academicYears}"
                                    th:value="${year.id}"
                                    th:text="${year.name}"
                                    th:selected="${year.id == currentYearId}">
                            </option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="classSelect">L·ªõp h·ªçc</label>
                        <select id="classSelect" class="info-value" onchange="loadSubjects()">
                            <option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="subjectSelect">M√¥n h·ªçc</label>
                        <select id="subjectSelect" class="info-value" onchange="loadStudents()">
                            <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button type="button" class="btn primary" sec:authorize="hasRole('ADMIN')" onclick="openPopup('addClassPopup')">‚ûï Th√™m l·ªõp h·ªçc</button>
                    <button type="button" class="btn primary" sec:authorize="hasRole('ADMIN')" onclick="openPopup('addSubjectPopup')">‚ûï Th√™m m√¥n h·ªçc</button>
                    <button type="button" class="btn primary" sec:authorize="hasRole('ADMIN')" id="addStudentBtn" onclick="openAddStudentPopup()" disabled>‚ûï Th√™m h·ªçc sinh</button>
                </div>
            </div>

            <!-- Danh s√°ch h·ªçc sinh -->
            <div class="info-section">
                <h2 class="info-section-title">Danh s√°ch h·ªçc sinh</h2>

                <!-- T√¨m ki·∫øm h·ªçc sinh -->
                <div class="student-search-form" id="studentSearchSection" style="display: none;">
                    <div class="search-row">
                        <div class="search-field">
                            <label class="search-label">CCCD</label>
                            <input class="search-input" type="text" id="searchCitizenId" maxlength="15">
                        </div>
                        <div class="search-field">
                            <label class="search-label">H·ªç v√† t√™n</label>
                            <input class="search-input" type="text" id="searchFullName">
                        </div>
                        <div class="search-field">
                            <label class="search-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input class="search-input" type="text" id="searchPhone" maxlength="10">
                        </div>
                    </div>
                    <div class="search-actions-row">
                        <div class="search-actions-left"></div>
                        <div class="search-actions-right">
                            <button type="button" class="btn primary" onclick="searchStudents()">üîé T√¨m ki·∫øm</button>
                            <button type="button" class="btn" onclick="clearStudentSearchFilters()">‚ùå X√≥a l·ªçc</button>
                        </div>
                    </div>
                </div>

                <div style="overflow:auto;">
                    <table class="student-table" id="studentTable">
                        <thead>
                        <tr>
                            <th>CCCD</th>
                            <th>H·ªç v√† t√™n</th>
                            <th>Ng√†y sinh</th>
                            <th>Gi·ªõi t√≠nh</th>
                            <th>SƒêT</th>
                            <th>T√¨nh tr·∫°ng</th>
                            <th>Thao t√°c</th>
                        </tr>
                        </thead>
                        <tbody id="studentTableBody">
                        <tr>
                            <td colspan="7" class="empty-row">Vui l√≤ng ch·ªçn nƒÉm h·ªçc, l·ªõp v√† m√¥n h·ªçc ƒë·ªÉ xem danh s√°ch h·ªçc sinh</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination - Dynamic -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <div class="pagination-info">
                        Hi·ªÉn th·ªã <span id="paginationShowing">0</span> / <span id="paginationTotal">0</span> h·ªçc sinh
                    </div>
                    <div class="pagination" id="paginationButtons">
                        <!-- Buttons will be generated by JavaScript -->
                    </div>
                    <div class="pagination-size">
                        <label>Hi·ªÉn th·ªã:</label>
                        <select id="pageSizeSelect" onchange="changePageSize(this.value)">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                </div>
            </div>
            <input type="hidden" id="userRole" sec:authorize="hasRole('ADMIN')" value="ADMIN">
            <input type="hidden" id="userRole" sec:authorize="hasRole('CASHIER')" value="CASHIER">
        </div>
    </main>
</div>

<!-- Popup Th√™m L·ªõp H·ªçc -->
<div id="addClassPopup" class="popup-overlay" onclick="closePopupOnOverlay(event, 'addClassPopup')">
    <div class="popup-content popup-small">
        <div class="popup-header">
            <h3 class="popup-title">‚ûï Th√™m l·ªõp h·ªçc</h3>
            <button class="popup-close" onclick="closePopup('addClassPopup')">&times;</button>
        </div>
        <form id="addClassForm" onsubmit="submitAddClass(event)">
            <div class="info-grid">
                <div class="info-label required">T√™n l·ªõp</div>
                <div>
                    <input class="info-value" type="text" id="newClassName" name="className" required placeholder="VD: L·ªõp 6, L·ªõp 7...">
                </div>
            </div>
            <div id="addClassError" class="alert alert-error" style="display: none; margin-top: 16px;"></div>
            <div id="addClassSuccess" class="alert alert-success" style="display: none; margin-top: 16px;"></div>
            <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closePopup('addClassPopup')">H·ªßy</button>
                <button type="submit" class="btn primary">‚ûï Th√™m l·ªõp</button>
            </div>
        </form>
    </div>
</div>

<!-- Popup Th√™m M√¥n H·ªçc -->
<div id="addSubjectPopup" class="popup-overlay" onclick="closePopupOnOverlay(event, 'addSubjectPopup')">
    <div class="popup-content popup-small">
        <div class="popup-header">
            <h3 class="popup-title">‚ûï Th√™m m√¥n h·ªçc</h3>
            <button class="popup-close" onclick="closePopup('addSubjectPopup')">&times;</button>
        </div>
        <form id="addSubjectForm" onsubmit="submitAddSubject(event)">
            <div class="info-grid">
                <div class="info-label required">T√™n m√¥n h·ªçc</div>
                <div>
                    <input class="info-value" type="text" id="newSubjectName" name="subjectName" required placeholder="VD: To√°n, VƒÉn, Anh...">
                </div>
            </div>
            <div id="addSubjectError" class="alert alert-error" style="display: none; margin-top: 16px;"></div>
            <div id="addSubjectSuccess" class="alert alert-success" style="display: none; margin-top: 16px;"></div>
            <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closePopup('addSubjectPopup')">H·ªßy</button>
                <button type="submit" class="btn primary">‚ûï Th√™m m√¥n</button>
            </div>
        </form>
    </div>
</div>

<!-- Popup Th√™m H·ªçc Sinh v√†o M√¥n H·ªçc -->
<div id="addStudentPopup" class="popup-overlay" onclick="closePopupOnOverlay(event, 'addStudentPopup')">
    <div class="popup-content popup-large">
        <div class="popup-header">
            <h3 class="popup-title">‚ûï Th√™m h·ªçc sinh v√†o m√¥n h·ªçc</h3>
            <button class="popup-close" onclick="closePopup('addStudentPopup')">&times;</button>
        </div>

        <!-- Thanh t√¨m ki·∫øm -->
        <div class="search-box">
            <input type="text" id="studentSearchInput" class="info-value" placeholder="üîç Nh·∫≠p t√™n h·ªçc sinh ƒë·ªÉ t√¨m ki·∫øm..." oninput="debounceSearch()">
        </div>

        <!-- S·ªë h·ªçc sinh ƒë√£ ch·ªçn -->
        <div class="selected-count">
            ƒê√£ ch·ªçn: <span id="selectedCount">0</span> h·ªçc sinh
        </div>

        <!-- Danh s√°ch h·ªçc sinh c√≥ th·ªÉ th√™m -->
        <div class="student-list-container">
            <table class="student-table student-select-table">
                <thead>
                <tr>
                    <th style="width: 50px;">
                        <input type="checkbox" id="selectAllStudents" onchange="toggleSelectAll()">
                    </th>
                    <th>CCCD</th>
                    <th>H·ªç v√† t√™n</th>
                    <th>Ng√†y sinh</th>
                    <th>SƒêT</th>
                </tr>
                </thead>
                <tbody id="availableStudentTableBody">
                <tr>
                    <td colspan="4" class="empty-row">ƒêang t·∫£i danh s√°ch h·ªçc sinh...</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="addStudentError" class="alert alert-error" style="display: none; margin-top: 16px;"></div>
        <div id="addStudentSuccess" class="alert alert-success" style="display: none; margin-top: 16px;"></div>

        <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
            <button type="button" class="btn" onclick="closePopup('addStudentPopup')">H·ªßy</button>
            <button type="button" class="btn primary" id="confirmAddStudents" onclick="submitAddStudents()">‚ûï Th√™m h·ªçc sinh ƒë√£ ch·ªçn</button>
        </div>
    </div>
</div>

<div id="removeStudentPopup" class="popup-overlay" onclick="closePopupOnOverlay(event, 'removeStudentPopup')">
    <div class="popup-content popup-small">
        <div class="popup-header">
            <h3 class="popup-title">‚ö†Ô∏è X√°c nh·∫≠n x√≥a h·ªçc sinh</h3>
            <button class="popup-close" onclick="closePopup('removeStudentPopup')">&times;</button>
        </div>
        <div class="popup-body">
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªçc sinh <strong id="removeStudentName"></strong> kh·ªèi m√¥n h·ªçc n√†y?</p>
            <input type="hidden" id="removeStudentCitizenId">
        </div>
        <div id="removeStudentError" class="alert alert-error" style="display: none; margin-top: 16px;"></div>
        <div id="removeStudentSuccess" class="alert alert-success" style="display: none; margin-top: 16px;"></div>
        <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
            <button type="button" class="btn" onclick="closePopup('removeStudentPopup')">H·ªßy</button>
            <button type="button" class="btn danger" onclick="submitRemoveStudent()">üóëÔ∏è X√≥a</button>
        </div>
    </div>
</div>

<script th:src="@{/js/app.js}"></script>
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/classes.js}"></script>
<script th:inline="javascript">
    // Auto load classes khi trang ƒë∆∞·ª£c t·∫£i n·∫øu ƒë√£ ch·ªçn nƒÉm h·ªçc
    document.addEventListener('DOMContentLoaded', function() {
        const yearSelect = document.getElementById('academicYearSelect');
        if (yearSelect.value) {
            loadClasses();
        }
    });
</script>
</body>
</html>
