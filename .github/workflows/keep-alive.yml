name: Keep Render Service Alive

on:
  schedule:
    # Ping every 10 minutes to prevent Render free tier from sleeping
    # Cron format: minute hour day month day-of-week
    # Note: GitHub Actions may have 5-15 minutes delay
    - cron: '*/10 * * * *'

  push:
    branches: [ main ]
    paths:
      - '.github/workflows/keep-alive.yml'

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  ping-service:
    name: Ping Render Service
    runs-on: ubuntu-latest

    steps:
      - name: Ping homepage (/)
        run: |
          echo "ğŸ  Pinging homepage at $(date '+%Y-%m-%d %H:%M:%S UTC')"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -L https://songlamedu.onrender.com/)
          
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 302 ] || [ "$RESPONSE" -eq 301 ]; then
            echo "âœ… Homepage is alive! HTTP Status: $RESPONSE"
          else
            echo "âš ï¸ Homepage returned HTTP Status: $RESPONSE"
            exit 1
          fi

      - name: Ping /me endpoint
        run: |
          echo "ğŸ‘¤ Pinging /me endpoint..."
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -L https://songlamedu.onrender.com/me)
          
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 302 ] || [ "$RESPONSE" -eq 301 ] || [ "$RESPONSE" -eq 401 ]; then
            echo "âœ… /me endpoint is alive! HTTP Status: $RESPONSE"
            if [ "$RESPONSE" -eq 401 ]; then
              echo "â„¹ï¸  401 is expected for unauthenticated requests"
            fi
          else
            echo "âš ï¸ /me endpoint returned HTTP Status: $RESPONSE"
            exit 1
          fi

      - name: Ping health endpoint (backup)
        run: |
          echo "ğŸ¥ Pinging health endpoint as backup..."
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://songlamedu.onrender.com/actuator/health)
          
          if [ "$RESPONSE" -eq 200 ]; then
            echo "âœ… Health endpoint is alive! HTTP Status: $RESPONSE"
          else
            echo "âš ï¸ Health endpoint returned HTTP Status: $RESPONSE"
            echo "Note: This is a backup check, main endpoints already confirmed"
          fi
        continue-on-error: true

      - name: Log summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All endpoints are responding!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ Service: https://songlamedu.onrender.com"
          echo "â° Next ping: ~10 minutes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Notify on failure
        if: failure()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ALERT: Service is not responding!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”— Check Render dashboard: https://dashboard.render.com"
          echo "ğŸŒ Service URL: https://songlamedu.onrender.com"
          echo "ğŸ“… Failed at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"